{% extends 'layout/base.html' %}

{% block bodytag %}onload="initialize()" onunload="GUnload()"{% endblock %}

{% block content %}

    {% form form %}
        {% for f in form %}
            {% field f %}
            {% ifequal f.name "location" %}
	    <script src="http://maps.google.com/maps?file=api&amp;v=2.x&amp;key=ABQIAAAAEApdQKp-3MQwXa7vqy-0PRTvq4UVAZ__u8Yk6PO6W14KUZrPkhTsRXWFwLdK0NTwbJRLBLmzeuZGsA" type="text/javascript"></script> 
            <script src="http://www.google.com/uds/api?file=uds.js&v=1.0&key=ABQIAAAAEApdQKp-3MQwXa7vqy-0PRTvq4UVAZ__u8Yk6PO6W14KUZrPkhTsRXWFwLdK0NTwbJRLBLmzeuZGsA" type="text/javascript"></script>

<!--goog local api key beta.secretlondon.us: ABQIAAAAEApdQKp-3MQwXa7vqy-0PRTvq4UVAZ__u8Yk6PO6W14KUZrPkhTsRXWFwLdK0NTwbJRLBLmzeuZGsA-->
<!--goog local api key localhost:8000: ABQIAAAAEApdQKp-3MQwXa7vqy-0PRQCULP4XOMyhPd8d_NrQQEO8sT8XBTlGvJCQhH0SlAnOODhv4dQJ__EbA-->
	    <script type="text/javascript"> 

		var map = null;
		var geocoder = null;
		var marker = null;
		var localSearch = new GlocalSearch();

		function initialize() {
		  if (GBrowserIsCompatible()) {
                    canvas = document.getElementById("map_canvas");
		    map = new GMap2(canvas);
		    map.setCenter(new GLatLng(51.52487262675978, -0.1064300537109375), 15);
		    map.addControl(new GLargeMapControl3D());
		    marker = new GMarker(new GLatLng(51.52487262675978, -0.1064300537109375), {draggable: true});
		    map.addOverlay(marker);
		    GEvent.addListener(marker, "dragend", function() {
		      point = marker.getPoint();
		      document.getElementById('id_latitude').value = point.lat();
		      document.getElementById('id_longitude').value = point.lng(); 
		    });
		    geocoder = new GClientGeocoder();
		  }
		}

		function showAddress(address) {

		  // first we try looking up using the google local ajax search API, which works better for postcodes

                  localSearch.setSearchCompleteCallback(null,
		      function() {
			if (localSearch.results[0]) {
			  var resultLat = localSearch.results[0].lat;
			  var resultLng = localSearch.results[0].lng;
			  var point = new GLatLng(resultLat,resultLng);
			  document.getElementById('id_latitude').value = resultLat;
			  document.getElementById('id_longitude').value = resultLng;
			  map.setCenter(point, 15);
                          if (marker) {
			    marker.setLatLng(new GLatLng(point.lat(), point.lng()));
			  }
			} else {
				// if local search fails, we try the geocode address search

				if (geocoder) {
				    geocoder.getLatLng(
				      address + ', London',
				      function(point) {
					if (!point) {
					  alert(address + " not found");
					} else {
					  document.getElementById('id_latitude').value = point.lat();
					  document.getElementById('id_longitude').value = point.lng();
					  map.setCenter(point, 15);
					  if (marker) {
					    marker.setLatLng(new GLatLng(point.lat(), point.lng()));
					  }
					}
				      }
				    );
				  }
			}
                      }
                    );
                  localSearch.execute(address + ', London');
		}

		</script>
		<p style="text-align: center; margin: 0 0 5px; text-align: center; width: 500px;"><input value="Find on map" onclick="return showAddress(document.getElementById('id_location').value)" type="button" /></p>
		<div id="map_canvas" style="width: 500px; height: 250px; margin-bottom: 5px;"></div> 

            {% endifequal %}
        {% endfor %}
    {% endform %}
    

{% endblock %}
