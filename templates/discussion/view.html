{% extends 'layout/base.html' %}

{% block pagemedia %}
<link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}/css/discussion.css" />
<script src="http://maps.google.com/maps?file=api&amp;v=2.x&amp;key={{GOOGLE_MAPS_API}}" type="text/javascript"></script> 
<script src="http://www.google.com/uds/api?file=uds.js&v=1.0&key={{GOOGLE_MAPS_API}}" type="text/javascript"></script>
<!--<script src="{{MEDIA_URL}}/js/proposal.js" type="text/javascript"></script>-->
<script src="{{MEDIA_URL}}/js/secret.edit.js" type="text/javascript"></script>
<script type="text/javascript" charset="utf-8">
    DISCUSSION_ID = '{{discussion.pk}}';
    $(document).ready(function(){$('#header_discussions').addClass('header-selected'); });
</script>
{% endblock %}


{% block facebook_js %}
{% ifequal request.GET.fb "d" %}
    {% include "discussion/render/facebook_publish.html" %}
{% endifequal %}
{% endblock %}

{% block content %}
<div id="top" class="g3">
    {% with discussion.created_by as u %}    
    <div class="chunk tops">
        <div class="float-left" style="padding-right:10px;">
            <img src="{{u.profile_image.small}}" alt="{{u.name}}"/>
        </div>
        <h3>Posted&nbsp;by<br/><a href="/account/{{u.pk}}/">{{u.name}}</a></h3>
        <p class="subtle">{{discussion.get_time_since_created}}</p>
    </div>
    {% endwith %}
</div>
<div class="g9">
    <div class="chunk">
        <h1>{{discussion.title}}</h1>
        <p>{{discussion.text|linebreaksbr}}</p>
        <p>{% include "render/share_page_buttons.html" %} &nbsp; <a href="{{discussion.get_flagspam_url}}" class="modalize" title="Report this topic">Report</a>
        {% with discussion as obj %}
        {% include "perm/editable_logic.html" %}
        {% endwith %}	    
        </p>
    </div>
</div>
<div id="proposals" class="clear-border"></div>
<div class="g9 prefix_3">
    <div class="chunk">
    <h3 class="caps">{{discussion.proposal_count}} secret{{discussion.proposal_count|pluralize}}<span class="subtle"> in {{discussion.comment_count}} post{{discussion.comment_count|pluralize}}</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="#reply" class="button" style="font-size:16px;">Post a Reply</a></h3>
    </div>
</div>
<div id="" class="clear"></div>
{% for comment in discussion.comments %}
<div class="border-top">
    <div class="g3">
        <div class="chunk">
        {% with comment.created_by as u %}
        <img src="{{u.profile_image.small}}" alt="{{u.name}}" class="float-left" style="padding-right:10px;"/> 
        <h3><a href="{{u.get_absolute_url}}">{{u.name}}</a></h3>
        <p class="subtle">{{comment.get_time_since_created}}</p>
        {% endwith %}
        <div class="clear"></div>            
        </div>
    </div>
    <div id="response-{{comment.pk}}" class="g8 suffix_1">
        <div class="chunk">
            <div class="float-right lefts bottoms">
                {% with comment as obj %}
                {% include "perm/editable_logic.html" %}
                {% endwith %}
            </div>
                {{comment.text|urlizetrunc:25|linebreaksbr}}
            {% for proposal in comment.proposals %}
                {% include 'comment/proposal.html' %}
            {% endfor %}&nbsp;
        </div>
    </div>
    <div class="clear"></div>
</div>
{% endfor %}
<div id="reply" class="clear-border"></div>
{% if user.is_authenticated %}
<div class="g3">
    <div class="chunk">
        {% with request.user as u %}
        <img src="{{u.profile_image.small}}" alt="{{u.name}}" class="float-left" style="padding-right:10px;"/> 
        <h3>{{u.name}}</h3>
        {% endwith %}
        <div class="clear"></div>            
        </div>
</div>
<div class="g8 suffix_1" style="padding-bottom: 150px;">    
    <form id="response_form" action="/discussion/{{discussion.pk}}/comment/" method="post" class="chunk">
        <div class="bottoms">
            <h3>{{discussion.title}}</h3>
            <textarea id="id_response_text" name="text" style="width:97%;height:90px;padding: 5px;margin-top:5px;"></textarea>
            <div id="error_message" class="tops" style="color:red;font-weight:bold;"></div>
        </div>
        <div style="width:350px;float:left">
            <h4 class="hidden">Mention a secret place</h4>
            <div id="selected_result" class="hidden isecret">
                <a href="#" class="float-right reset_selected" style="font-weight:bold;font-size:18px;">X</a>
                <div class="ctext">            
                <h3 id="selected_title"></h3>
                <p id="selected_address"></p>
                </div>
                <div class="clear"></div>
            </div>    		
            <div id="select_result" class="isecret">            
                <strong>Mention a secret place</strong><br/>
                <input type="text" name="title" id="id_title" style="width:95%;font-weight:bold;font-size:16px;line-height:16px;padding: 5px;"/>
                <div id="results_manual" class="hidden">
                    <strong>Address</strong><br/>
                    <input id="id_location" type="text" name="location" maxlength="250" />
                    <input type="button" value="Finished" id="finished_manual"/> or <a href="#" class="unselect_manual">edit name</a>
                </div>
    		</div>
    		<div id="results_fail" class="tops isecret hidden">
                <h3><a href="#" class="select_manual">Create new secret place</a></h3>
                <p class="subtle">If you haven't found what you're looking for</p>                        
            </div>
    		<div id="results_success" class="hidden tops" style="padding:5px 0px;">                
                <div class="">
                    <h3 class="subtle">Or, did you mean...</h3>
                </div>
                <div class="tops bottoms">
                <div id="existing_suggestions_success" class="hidden">                        
                    <ul id="existing_suggestions" class="suggestion"></ul>
                </div>               
                <div id="google_suggestions_success" class="hidden">
                    <ul id="google_suggestions" class="suggestion"></ul>
                </div>
                </div>                
            </div>
		</div>
		<div class="buttons text-right" style="float:right;width: 175px;">
			<input id="post_response" type="submit" name="sub_share" value="Post" class="button" style="font-size:16px;">
			<!--<input type="button" name="sub_cancel" value="CANCEL" class="pink_button cancel">-->
			<br class="clear_left" />
		</div>
		<div class="clear"></div>
		<div id="google_map" style="display:none;width:340px;height:170px;"></div>
		<div class="hidden">    		
            <div id="google_suggestions_fail" class="hidden">&nbsp;</div>
            <div id="existing_suggestions_fail" class="hidden">&nbsp;</div>
            <input id="id_secret_id" type="text" name="secrets" maxlength="250" />            
            <input id="id_google_reff" type="text" name="google_reff" maxlength="250" /><br/>
            <input type="text" name="latitude" id="id_latitude" /><br/>
            <input type="text" name="longitude" id="id_longitude" /><br/>
        </div>
	</form>
	
</div> 
{% else %}
<div class="chunk center">
   <h3>To reply to this discussion, please login via Facebook</h3>
   <div class="tops">
   {% include 'accounts/fb_button.html' %}
   </div>
</div>
{% endif %}
{% if num_results %}
<div class="clear-border"></div>
<div class="chunk center">
    <a href="#top">&uarr; Back to top</a>
</div>
{% endif %}
<!--
<div class="clear-border"></div>
<div class="chunk center">
    {% if discussion.previous_page %}<a href="?page={{discussion.previous_page}}">Prev</a>{% endif %}
    {% for p in discussion.xpages %}
        {% ifequal p discussion.page %}
            <b>{{p}}</b>
        {% else %}
            <a href="?page={{p}}">{{p}}</a>
        {% endifequal %}
    {% endfor %}
    {% if discussion.next_page %}<a href="?page={{discussion.next_page}}">Next</a>{% endif %}
</div>
-->
{% if discussion.was_before_birth %}
    <div class="clear-border"></div>
    <div class="chunk">        
		<div class="moderation_holder">
			<p class="moderated">This topic has been rewritten <a href="/note/rewritten/" class="modalize" title="Why has this topic been rewritten?">Why?</a></p>
		</div>    
    </div>           
{% endif %}
{% endblock %}
